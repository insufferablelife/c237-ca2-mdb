<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Funny MDB - Movie List</title>
    <link rel="icon" href="images/funky-cirno.gif" type="image/gif">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <style>
      /* Custom CSS for Star Rating and Card Layout */
      body {
          background-color: #f0f2f5; /* Light grey background for contrast with dark cards */
      }

      /* Style for the movie image in the card */
      .card-img-top {
          max-width: 100%; /* Ensure image fits card */
          height: 250px; /* Increased height for better visibility */
          object-fit: contain; /* Contain the image within its bounds */
          padding: 15px; /* Add some padding around the image */
          background-color: #212529; /* Dark background for the image section */
          border-bottom: 1px solid rgba(0,0,0,.125); /* Subtle separator */
      }

      /* Adjust the card body to use flex for better alignment of elements */
      .card-body {
          display: flex;
          flex-direction: column;
          /* justify-content: space-between; This was pushing content too far apart */
          background-color: #343a40; /* Dark background for card body */
          color: white; /* White text for contrast */
          padding: 20px;
      }

      .card-title {
          font-size: 1.8rem; /* Larger font size for title */
          font-weight: bold;
          text-align: left; /* Align title to left like example */
          margin-bottom: 5px;
          color: white;
      }

      .movie-info-text {
          font-size: 0.95rem; /* Slightly larger for rating/date */
          color: #adb5bd; /* Lighter grey for info text */
          text-align: left; /* Align to left */
          margin-bottom: 5px;
      }

      .btn-view-description {
          background-color: #0dcaf0; /* Info blue for the button */
          border-color: #0dcaf0;
          color: black; /* Black text for button */
          font-weight: bold;
          margin-top: 15px; /* Space above button */
      }
      .btn-view-description:hover {
          background-color: #3dd5f3; /* Lighter blue on hover */
          border-color: #3dd5f3;
      }

      /* Hide edit/delete buttons for a cleaner card if not in admin view */
      .admin-actions {
          display: flex;
          justify-content: space-around;
          margin-top: 15px;
          padding-top: 15px;
          border-top: 1px solid rgba(255,255,255,0.1);
      }
      .admin-actions .btn {
          font-size: 0.85rem;
      }
    </style>
  </head>
<body>
  <nav class="navbar navbar-expand-sm bg-dark navbar-dark">
    <div class="container-fluid">
      <a class="navbar-brand" href="/">Movie</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#collapsibleNavbar">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="collapsibleNavbar">
        <ul class="navbar-nav">
          <li class="nav-item">
            <a class="nav-link" href="/movieList">List of Movies</a>
          </li> 
          <li class="nav-item">
            <a class="nav-link" href="/addMovie">Add New Movies</a>
          </li> 
          <li class="nav-item">
            <a class="nav-link" href="/logout">Logout</a>
          </li> 
        </ul>
      </div>
    </div>
  </nav>

  <div class="container mt-4">
    <p class="text-white bg-dark p-2 rounded">Welcome, <%= user.username %> (<%= user.role %>)</p>
    <br>
    <div class="text-center text-white bg-dark p-3 rounded"><h2>SUPA ACTION PACKED MOVIES</h2></div>
    <br>

    <form method="GET" action="/movieList" class="mb-4 d-flex justify-content-center align-items-center gap-2">
      <div class="input-group" style="max-width: 300px;">
        <input type="text" class="form-control" name="search" placeholder="Search movies..." value="<%= search %>">
      </div>
      
      <div class="input-group" style="max-width: 200px;">
        <select name="rating" class="form-select">
          <option value="">All Ratings</option>
          <option value="G" <%= ratingFilter === 'G' ? 'selected' : '' %>>G</option>
          <option value="PG" <%= ratingFilter === 'PG' ? 'selected' : '' %>>PG</option>
          <option value="PG-13" <%= ratingFilter === 'PG-13' ? 'selected' : '' %>>PG-13</option>
          <option value="R" <%= ratingFilter === 'R' ? 'selected' : '' %>>R</option>
        </select>
      </div>
      
      <button type="submit" class="btn btn-primary">Search</button>
    </form>

    <div class="row row-cols-1 row-cols-md-2 row-cols-lg-4 g-4">
      <% if (movies && movies.length > 0) { %>
        <% for(let i=0; i < movies.length; i++) { %>
          <div class="col">
            <div class="card h-100 shadow">
              <img src="images/<%= movies[i].image %>" class="card-img-top" alt="<%= movies[i].name %> Cover">
              <div class="card-body">
                <h5 class="card-title"><%= movies[i].name %></h5>
                <div class="star-rating" data-rating="<%= movies[i].rating %>"></div> 
                <p class="movie-info-text"><%= movies[i].rating %>/5</p>
                <p class="movie-info-text">Release Date: <%= movies[i].releaseDate %></p>
                
                <button type="button" class="btn btn-info btn-view-description mt-3" 
                        data-bs-toggle="modal" 
                        data-bs-target="#movieDescriptionModal"
                        data-movie-name="<%= movies[i].name %>"
                        data-movie-description="<%= movies[i].description %>">
                  View Description
                </button>

                <% if (user.role === 'admin') { %>
                  <div class="admin-actions">
                      <a href="/updateMovie/<%= movies[i].movieId %>" class="btn btn-outline-secondary btn-sm">Edit</a>
                      <a href="/deleteMovie/<%= movies[i].movieId %>" class="btn btn-outline-danger btn-sm" onclick="return confirm('ARE U SURE YUO WANT TO DELETE THE ACTION PACKED MVOIE???')">Delete</a>
                  </div>
                <% } %>
              </div>
            </div>
          </div>
        <% } %>
      <% } else { %>
        <div class="col-12 text-center">
            <p class="alert alert-info">No movies found.</p>
        </div>
      <% } %>
    </div>
  </div>

  <div class="modal fade" id="movieDescriptionModal" tabindex="-1" aria-labelledby="movieDescriptionModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content bg-dark text-white">
        <div class="modal-header">
          <h5 class="modal-title" id="movieDescriptionModalLabel">Movie Description</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="movieDescriptionModalBody">
          </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // JavaScript for Star Rating
    document.addEventListener('DOMContentLoaded', () => {
        const starRatings = document.querySelectorAll('.star-rating');

        starRatings.forEach(starRatingContainer => {
            const rating = parseFloat(starRatingContainer.dataset.rating);
            const maxRating = 5; 

            starRatingContainer.innerHTML = ''; 

            const emptyStars = document.createElement('div');
            emptyStars.className = 'empty-stars';
            emptyStars.innerHTML = '<i class="far fa-star"></i><i class="far fa-star"></i><i class="far fa-star"></i><i class="far fa-star"></i><i class="far fa-star"></i>';
            starRatingContainer.appendChild(emptyStars);

            const filledStars = document.createElement('div');
            filledStars.classList.add('filled-stars');
            filledStars.innerHTML = '<i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i>';

            const percentage = (rating / maxRating) * 100;
            filledStars.style.width = `${percentage}%`;

            starRatingContainer.appendChild(filledStars);
        });

        // JavaScript for Modal Population
        const movieDescriptionModal = document.getElementById('movieDescriptionModal');
        movieDescriptionModal.addEventListener('show.bs.modal', event => {
            // Button that triggered the modal
            const button = event.relatedTarget;
            // Extract info from data-bs-* attributes
            const movieName = button.getAttribute('data-movie-name');
            const movieDescription = button.getAttribute('data-movie-description');

            // Update the modal's content.
            const modalTitle = movieDescriptionModal.querySelector('.modal-title');
            const modalBody = movieDescriptionModal.querySelector('.modal-body');

            modalTitle.textContent = movieName;
            modalBody.textContent = movieDescription; // Use textContent to prevent XSS if description contains HTML
        });
    });
  </script>
</body>
</html>